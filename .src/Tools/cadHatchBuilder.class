' Gambas class file

' GambasCAD
' A simple CAD made in Gambas
'
' Copyright (C) Ing Martin P Cristia
'
' This program is free software; you can redistribute it and/or modify
' it under the terms of the GNU General Public License as published by
' the Free Software Foundation; either version 3 of the License, or
' (at your option) any later version.
'
' This program is distributed in the hope that it will be useful,
' but WITHOUT ANY WARRANTY; without even the implied warranty of
' MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
' GNU General Public License for more details.
'
' You should have received a copy of the GNU General Public License
' along with this program; if not, write to the Free Software
' Foundation, Inc., 51 Franklin St, Fifth Floor,
' Boston, MA  02110-1301  USA

Inherits ToolsBase
Public Const Gender As String = "HATCHS"

Public StepsDone As Integer

Public UserResponse As Integer  ' 1 = Cancel ; 2 =
Public entHatch As Entity

Public Function Start(Optional filename As Variant, Optional _mode As Integer = 0) As Boolean

    Dim xf As String[]
    Dim f As String
    Dim iREt, nsel As Integer
    Dim eBorder As Entity

    ' desde el grafico entramos siempre a esta parte de la clase
    ' yo tengo q saber el estado de la comunicacion con el user
    ' entonces verifico

    Select Case StepsDone
        Case 0 ' nuevo hatch

            iRet = FHatch.Showmodal()

            Debug gcd.Drawing.LastHatchFile

            Select Case iRet
                Case 2 ' busqueda de contorno
                    gcd.clsJobPrevious = Me
                    gcd.clsJob = cadSelection

                    StepsDone = 1 ' cuando vuelvo aca, ya tengo un contorno

                Case 1 ' el user cancelo el hetch
                    gcd.clsJobPrevious = Me
                    gcd.clsJob = cadSelection
                    StepsDone = 0 ' cuando vuelvo aca, empiezo de nuevo

            End Select

        Case 1 ' vengo de seleccionar los parametros de hatch

            nSel = gcd.Drawing.SelectedEntities.Count
            If nsel = 0 Then Return
            If (gcd.Drawing.SelectedEntities[gcd.Drawing.SelectedEntities.First].Gender <> "LWPOLYLINE") And (gcd.Drawing.SelectedEntities[gcd.Drawing.SelectedEntities.First].PolyLine.Count < 6) Then
                Message("El contorno esta mal definido")

            Else
                StepsDone = 2
                iRet = FHatch.Showmodal()

                Debug gcd.Drawing.LastHatchFile

                Select Case iRet
                    Case 2 ' nueva busqueda de contorno
                        gcd.clsJobPrevious = Me
                        gcd.clsJob = cadSelection
                        StepsDone = 1 ' cuando vuelvo aca, ya tengo un contorno

                    Case 1 ' el user cancelo el hetch
                        gcd.clsJobPrevious = Me
                        gcd.clsJob = cadSelection
                        StepsDone = 0 ' cuando vuelvo aca, empiezo de nuevo

                    Case 3 ' confirma el Hatch

                        entHatch = Gcd.CCC["HATCH"].newentity(, True)
                        entHatch.Gender = "HATCH"

                        entHatch.sParam[Gcd.CCC["HATCH"].sdaPattern] = gcd.Drawing.LastHatchPattern
                        entHatch.sParam[Gcd.CCC["HATCH"].sdaPaternFile] = gcd.Drawing.LastHatchFile

                        entHatch.fParam[Gcd.CCC["HATCH"].ipaScale] = gcd.Drawing.LastScale
                        entHatch.fParam[Gcd.CCC["HATCH"].ipaRotation] = gcd.Drawing.LastAngle

                        entHatch.pLayer = gcd.Drawing.CurrLayer ' "0" 'gcd.GetpLayer(fMain.CurrentLayer)

                        entHatch.pBlock = New Hatch

                        entHatch.pBlock.eSegments = New Entity[]

                        For Each eBorder In gcd.Drawing.SelectedEntities
                            Select Case eBorder.Gender  ' veo si me sirve de borde
                                Case "LINE"

                                    entHatch.pBlock.eSegments.Add(eBorder)
                                Case "LWPOLYLINE"
                                    entHatch.pBlock.eSegments.Add(eBorder)
                                Case Else

                            End Select

                        Next

                        gcd.Drawing.Entities.Add(entHatch, entHatch.Handle)
                        Gcd.CCC[entHatch.gender].Finish(entHatch)

                        'LastEntity = entHatch                                       ' save it to repeat on rigth click

                        gcd.clsJobPrevious = Me
                        gcd.clsJob = cadSelection
                        cadSelection.PoiChecking = True
                        DrawingAids.CleanTexts

                        'clsEntities.GLGenDrawList

                        gcd.Regen()

                End Select

            Endif

    End Select

End
